from Spotfire.Dxp.Data import DataFunctionDefinitionBuilder, DataType

def add_output_params_if_missing(dfname, outputvars):
    """
    Adds missing output parameters to a Python Data Function in Spotfire.
    
    :param dfname: Name of the data function in Document.Data.DataFunctions
    :param outputvars: List of (param_name, param_type) tuples like [("output1", DataType.Table)]
    """
    existing_definition = None
    for df in Document.Data.DataFunctions:
        if df.Name == dfname:
            existing_definition = df
            break

    if existing_definition is None:
        raise Exception("‚ùå Data Function '{}' not found.".format(dfname))

    # Extract script and language from the definition
    script = existing_definition.Script
    language = existing_definition.ScriptLanguage

    # Rebuild definition using a builder
    builder = DataFunctionDefinitionBuilder(language)
    builder.Script = script

    # Track all existing output parameters
    existing_output_names = [param.Name for param in existing_definition.Parameters if param.IsOutput]

    # Re-add all parameters (input + output)
    for param in existing_definition.Parameters:
        if param.IsOutput:
            builder.AddOutputParameter(param.Name, param.Type)
        else:
            builder.AddInputParameter(param.Name, param.Type)

    # Add only missing output parameters
    added_any = False
    for param_name, param_type in outputvars:
        if param_name not in existing_output_names:
            builder.AddOutputParameter(param_name, param_type)
            added_any = True
            print("‚úÖ Added missing output parameter:", param_name)
        else:
            print("‚ö†Ô∏è Output parameter already exists:", param_name)

    # If new outputs added, rebuild and replace definition
    if added_any:
        new_def = builder.Build()
        Document.Data.DataFunctions.Remove(existing_definition)
        Document.Data.DataFunctions.Add(new_def)
        print("üîÅ Data function '{}' updated.".format(dfname))
    else:
        print("‚úÖ No changes made to data function '{}'.".format(dfname))
